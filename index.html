import React, { useState, useEffect } from 'react';

export default function CoachGirlieApp() {
  const [activeTab, setActiveTab] = useState('log');
  const [logs, setLogs] = useState([]);
  const [dayType, setDayType] = useState('');
  const [selectedMood, setSelectedMood] = useState('');
  const [fasted, setFasted] = useState(false);
  const [carbload, setCarbload] = useState(false);
  const [freshActivity, setFreshActivity] = useState('');
  const [brickActivities, setBrickActivities] = useState([]);
  const [currentMonth, setCurrentMonth] = useState(new Date());
  const [apiKey, setApiKey] = useState('');
  const [chatMessages, setChatMessages] = useState([]);
  const [chatInput, setChatInput] = useState('');
  const [spinData, setSpinData] = useState({
    time: '', ftpAvg: '', ftpMax: '', wattAvg: '', wattMax: '',
    bpmAvg: '', bpmMax: '', rpmAvg: '', rpmMax: '', kmhAvg: '', kmhMax: '',
    distance: '', calories: '', tss: '',
    intense: false, aerobic: false, dynamic: false, vo2: false
  });
  const [bbData, setBbData] = useState({
    time: '', bar: false, loose: false, bodyweight: false,
    warmup: '', squats: '', back: '', chest: '', triceps: '', biceps: '',
    lunges: '', shoulders: '', abs: '', bpmAvg: '', bpmMax: '',
    intense: false, aerobic: false, anaerobic: false, vo2: false
  });

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    try {
      const logsResult = await window.storage.get('coach_girlie_logs');
      if (logsResult) setLogs(JSON.parse(logsResult.value));
      const apiKeyResult = await window.storage.get('coach_girlie_api_key');
      if (apiKeyResult) setApiKey(apiKeyResult.value);
      const chatResult = await window.storage.get('coach_girlie_chat');
      if (chatResult) setChatMessages(JSON.parse(chatResult.value));
    } catch (e) {
      console.log('No saved data yet');
    }
  };

  const saveLog = async () => {
    if (!dayType) {
      alert('Please select a day type, Bestie!');
      return;
    }
    const newLog = {
      date: new Date().toISOString(),
      dayType,
      mood: selectedMood,
      fasted,
      carbload,
      activities: []
    };
    if (dayType === 'fresh') {
      if (freshActivity === 'spin') {
        newLog.activities.push({ type: 'spin', ...spinData });
      } else if (freshActivity === 'bodybump') {
        newLog.activities.push({ type: 'bodybump', ...bbData });
      }
    } else {
      newLog.activities = brickActivities.filter(a => a.type);
    }
    const updatedLogs = [...logs, newLog];
    setLogs(updatedLogs);
    await window.storage.set('coach_girlie_logs', JSON.stringify(updatedLogs));
    alert('üéâ Saved, Queen! You crushed it today!');
    resetForm();
  };

  const resetForm = () => {
    setDayType('');
    setSelectedMood('');
    setFasted(false);
    setCarbload(false);
    setFreshActivity('');
    setBrickActivities([]);
    setSpinData({
      time: '', ftpAvg: '', ftpMax: '', wattAvg: '', wattMax: '',
      bpmAvg: '', bpmMax: '', rpmAvg: '', rpmMax: '', kmhAvg: '', kmhMax: '',
      distance: '', calories: '', tss: '',
      intense: false, aerobic: false, dynamic: false, vo2: false
    });
    setBbData({
      time: '', bar: false, loose: false, bodyweight: false,
      warmup: '', squats: '', back: '', chest: '', triceps: '', biceps: '',
      lunges: '', shoulders: '', abs: '', bpmAvg: '', bpmMax: '',
      intense: false, aerobic: false, anaerobic: false, vo2: false
    });
  };

  const addBrickActivity = () => {
    setBrickActivities([...brickActivities, { type: 'spin', time: '', bpm: '', notes: '' }]);
  };

  const updateBrickActivity = (index, field, value) => {
    const updated = [...brickActivities];
    updated[index][field] = value;
    setBrickActivities(updated);
  };

  const removeBrickActivity = (index) => {
    setBrickActivities(brickActivities.filter((_, i) => i !== index));
  };

  const sendChatMessage = async () => {
    if (!chatInput.trim()) return;
    if (!apiKey) {
      alert('Please enter your OpenAI API key first, Diva!');
      return;
    }
    const userMessage = { role: 'user', content: chatInput };
    const updatedMessages = [...chatMessages, userMessage];
    setChatMessages(updatedMessages);
    setChatInput('');
    try {
      const statsContext = `User's recent stats: ${logs.slice(-5).map(l => 
        `${new Date(l.date).toLocaleDateString()}: ${l.dayType} day, mood ${l.mood}, ${l.activities.length} activities`
      ).join('; ')}`;
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 1000,
          system: `You are Coach Girlie, a sassy, supportive fitness coach. Call the user "Bestie", "Queen", or "Diva". Give personalized advice based on their stats. Be encouraging but real. ${statsContext}`,
          messages: updatedMessages
        })
      });
      const data = await response.json();
      const assistantMessage = { role: 'assistant', content: data.content[0].text };
      const finalMessages = [...updatedMessages, assistantMessage];
      setChatMessages(finalMessages);
      await window.storage.set('coach_girlie_chat', JSON.stringify(finalMessages));
    } catch (error) {
      alert('Oops! Chat failed. Check your API key, Bestie!');
    }
  };

  const calculatePRs = () => {
    const spinLogs = logs.flatMap(l => l.activities.filter(a => a.type === 'spin'));
    const bbLogs = logs.flatMap(l => l.activities.filter(a => a.type === 'bodybump'));
    const brickLogs = logs.filter(l => l.dayType === 'brick');
    return {
      spinMaxWatt: Math.max(...spinLogs.map(s => parseFloat(s.wattAvg) || 0), 0),
      spinMaxDistance: Math.max(...spinLogs.map(s => parseFloat(s.distance) || 0), 0),
      spinMaxTSS: Math.max(...spinLogs.map(s => parseFloat(s.tss) || 0), 0),
      bbMaxTracks: Math.max(...bbLogs.map(b => 
        [b.warmup, b.squats, b.back, b.chest, b.triceps, b.biceps, b.lunges, b.shoulders, b.abs].filter(t => t).length
      ), 0),
      brickMaxActivities: Math.max(...brickLogs.map(b => b.activities.length), 0),
      brickMaxTime: Math.max(...brickLogs.map(b => b.activities.reduce((sum, a) => sum + (parseFloat(a.time) || 0), 0)), 0),
      streak: calculateStreak()
    };
  };

  const calculateStreak = () => {
    if (logs.length === 0) return 0;
    const sorted = logs.map(l => new Date(l.date)).sort((a, b) => b - a);
    let streak = 1;
    for (let i = 1; i < sorted.length; i++) {
      const diff = (sorted[i - 1] - sorted[i]) / (1000 * 60 * 60 * 24);
      if (diff <= 1) streak++;
      else break;
    }
    return streak;
  };

  const prs = calculatePRs();

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-600 via-pink-500 to-purple-800 text-white">
      <div className="max-w-2xl mx-auto h-screen flex flex-col">
        <div className="bg-black bg-opacity-30 backdrop-blur-lg p-4 text-center">
          <h1 className="text-3xl font-black uppercase tracking-wider">üí™ Coach Girlie Pro Max üëë</h1>
        </div>
        <div className="flex bg-black bg-opacity-20">
          {[['log', 'LOG'], ['history', 'HISTORY'], ['pr', 'PR BOARD'], ['chat', 'CHAT']].map(([tab, label]) => (
            <button key={tab} onClick={() => setActiveTab(tab)}
              className={`flex-1 py-3 text-sm font-bold ${activeTab === tab ? 'bg-white bg-opacity-20 border-b-4 border-white' : 'opacity-60'}`}>
              {label}
            </button>
          ))}
        </div>
        <div className="flex-1 overflow-y-auto p-4 space-y-4">
          {activeTab === 'log' && (
            <>
              <div className="bg-white bg-opacity-15 backdrop-blur-lg p-4 rounded-xl">
                <label className="block font-bold text-sm mb-2 uppercase">Day Type</label>
                <div className="flex gap-3">
                  {['fresh', 'brick'].map(type => (
                    <label key={type} className="flex items-center gap-2 cursor-pointer">
                      <input type="radio" checked={dayType === type} onChange={() => setDayType(type)} className="w-5 h-5" />
                      <span className="capitalize">{type}</span>
                    </label>
                  ))}
                </div>
              </div>
              <div className="bg-white bg-opacity-15 backdrop-blur-lg p-4 rounded-xl">
                <label className="block font-bold text-sm mb-2 uppercase">Conditions</label>
                <div className="space-y-2">
                  <label className="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" checked={fasted} onChange={(e) => setFasted(e.target.checked)} className="w-5 h-5" />
                    <span>Fasted Training</span>
                  </label>
                  <label className="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" checked={carbload} onChange={(e) => setCarbload(e.target.checked)} className="w-5 h-5" />
                    <span>Carbload Evening Before</span>
                  </label>
                </div>
              </div>
              <div className="bg-white bg-opacity-15 backdrop-blur-lg p-4 rounded-xl">
                <label className="block font-bold text-sm mb-2 uppercase">Mood</label>
                <div className="flex gap-2 justify-around">
                  {['üòû', 'üòê', 'üôÇ', 'üòÅ', 'ü•≥'].map(mood => (
                    <button key={mood} onClick={() => setSelectedMood(mood)}
                      className={`text-4xl w-16 h-16 rounded-full bg-white bg-opacity-20 ${selectedMood === mood ? 'border-4 border-white scale-110' : ''}`}>
                      {mood}
                    </button>
                  ))}
                </div>
              </div>
              {dayType === 'fresh' && (
                <>
                  <div className="bg-white bg-opacity-15 backdrop-blur-lg p-4 rounded-xl">
                    <label className="block font-bold text-sm mb-2 uppercase">Activity</label>
                    <div className="grid grid-cols-2 gap-3">
                      {[['spin', 'SPIN'], ['bodybump', 'BODYBUMP']].map(([act, label]) => (
                        <button key={act} onClick={() => setFreshActivity(act)}
                          className={`p-3 rounded-lg font-bold border-2 ${freshActivity === act ? 'bg-white bg-opacity-40 border-white' : 'bg-white bg-opacity-20 border-transparent'}`}>
                          {label}
                        </button>
                      ))}
                    </div>
                  </div>
                  {freshActivity === 'spin' && (
                    <div className="bg-white bg-opacity-15 backdrop-blur-lg p-4 rounded-xl space-y-3">
                      <label className="block font-bold text-sm uppercase">Spin Session</label>
                      <input type="number" placeholder="Time (min)" value={spinData.time}
                        onChange={(e) => setSpinData({...spinData, time: e.target.value})}
                        className="w-full p-2 rounded-lg bg-white text-gray-900" />
                      <div className="grid grid-cols-2 gap-2">
                        {[['ftpAvg', 'FTP Avg'], ['ftpMax', 'FTP Max'], ['wattAvg', 'Watt Avg'], ['wattMax', 'Watt Max'],
                          ['bpmAvg', 'BPM Avg'], ['bpmMax', 'BPM Max'], ['rpmAvg', 'RPM Avg'], ['rpmMax', 'RPM Max'],
                          ['kmhAvg', 'Km/h Avg'], ['kmhMax', 'Km/h Max'], ['distance', 'Distance'], ['calories', 'Calories']].map(([key, label]) => (
                          <input key={key} type="number" placeholder={label} value={spinData[key]}
                            onChange={(e) => setSpinData({...spinData, [key]: e.target.value})}
                            className="p-2 rounded-lg bg-white text-gray-900" />
                        ))}
                      </div>
                      <input type="number" placeholder="TSS" value={spinData.tss}
                        onChange={(e) => setSpinData({...spinData, tss: e.target.value})}
                        className="w-full p-2 rounded-lg bg-white text-gray-900" />
                      <div className="space-y-2">
                        <label className="font-bold text-xs uppercase">Effort Points</label>
                        {[['intense', 'Intense'], ['aerobic', 'Aerobic'], ['dynamic', 'Dynamic'], ['vo2', 'VO2 Max']].map(([key, label]) => (
                          <label key={key} className="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" checked={spinData[key]}
                              onChange={(e) => setSpinData({...spinData, [key]: e.target.checked})} className="w-4 h-4" />
                            <span>{label}</span>
                          </label>
                        ))}
                      </div>
                    </div>
                  )}
                  {freshActivity === 'bodybump' && (
                    <div className="bg-white bg-opacity-15 backdrop-blur-lg p-4 rounded-xl space-y-3">
                      <label className="block font-bold text-sm uppercase">Bodybump Session</label>
                      <input type="number" placeholder="Time (min)" value={bbData.time}
                        onChange={(e) => setBbData({...bbData, time: e.target.value})}
                        className="w-full p-2 rounded-lg bg-white text-gray-900" />
                      <div className="space-y-2">
                        <label className="font-bold text-xs uppercase">Weights Used</label>
                        {[['bar', 'Bar'], ['loose', 'Loose'], ['bodyweight', 'Bodyweight']].map(([key, label]) => (
                          <label key={key} className="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" checked={bbData[key]}
                              onChange={(e) => setBbData({...bbData, [key]: e.target.checked})} className="w-4 h-4" />
                            <span>{label}</span>
                          </label>
                        ))}
                      </div>
                      <label className="font-bold text-xs uppercase">Track Breakdown</label>
                      {['warmup', 'squats', 'back', 'chest', 'triceps', 'biceps', 'lunges', 'shoulders', 'abs'].map(track => (
                        <input key={track} type="text" placeholder={track.charAt(0).toUpperCase() + track.slice(1)}
                          value={bbData[track]} onChange={(e) => setBbData({...bbData, [track]: e.target.value})}
                          className="w-full p-2 rounded-lg bg-white text-gray-900" />
                      ))}
                      <div className="grid grid-cols-2 gap-2">
                        <input type="number" placeholder="BPM Avg" value={bbData.bpmAvg}
                          onChange={(e) => setBbData({...bbData, bpmAvg: e.target.value})}
                          className="p-2 rounded-lg bg-white text-gray-900" />
                        <input type="number" placeholder="BPM Max" value={bbData.bpmMax}
                          onChange={(e) => setBbData({...bbData, bpmMax: e.target.value})}
                          className="p-2 rounded-lg bg-white text-gray-900" />
                      </div>
                      <div className="space-y-2">
                        <label className="font-bold text-xs uppercase">Effort</label>
                        {[['intense', 'Intense'], ['aerobic', 'Aerobic'], ['anaerobic', 'Anaerobic'], ['vo2', 'VO2 Max']].map(([key, label]) => (
                          <label key={key} className="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" checked={bbData[key]}
                              onChange={(e) => setBbData({...bbData, [key]: e.target.checked})} className="w-4 h-4" />
                            <span>{label}</span>
                          </label>
                        ))}
                      </div>
                    </div>
                  )}
                </>
              )}
              {dayType === 'brick' && (
                <div className="space-y-3">
                  {brickActivities.map((activity, idx) => (
                    <div key={idx} className="bg-white bg-opacity-15 backdrop-blur-lg p-4 rounded-xl space-y-3 relative">
                      <button onClick={() => removeBrickActivity(idx)}
                        className="absolute top-2 right-2 bg-pink-600 text-white rounded-full w-8 h-8 font-bold">
                        √ó
                      </button>
                      <select value={activity.type} onChange={(e) => updateBrickActivity(idx, 'type', e.target.value)}
                        className="w-full p-2 rounded-lg bg-white text-gray-900">
                        <option value="spin">Spin</option>
                        <option value="bodypump">Bodypump</option>
                        <option value="yin">Yin Yoga</option>
                        <option value="pilates">Mat Pilates</option>
                      </select>
                      <input type="number" placeholder="Time (min)" value={activity.time}
                        onChange={(e) => updateBrickActivity(idx, 'time', e.target.value)}
                        className="w-full p-2 rounded-lg bg-white text-gray-900" />
                      <input type="number" placeholder="BPM" value={activity.bpm}
                        onChange={(e) => updateBrickActivity(idx, 'bpm', e.target.value)}
                        className="w-full p-2 rounded-lg bg-white text-gray-900" />
                      <textarea placeholder="Notes" value={activity.notes}
                        onChange={(e) => updateBrickActivity(idx, 'notes', e.target.value)}
                        className="w-full p-2 rounded-lg bg-white text-gray-900" rows="2" />
                    </div>
                  ))}
                  <button onClick={addBrickActivity}
                    className="w-full bg-gradient-to-r from-pink-500 to-purple-600 text-white py-3 rounded-full font-bold uppercase">
                    + Add Activity
                  </button>
                </div>
              )}
              <button onClick={saveLog}
                className="w-full bg-gradient-to-r from-pink-500 to-purple-600 text-white py-4 rounded-full font-bold uppercase text-lg shadow-lg">
                üíæ Save Log
              </button>
            </>
          )}
          {activeTab === 'history' && (
            <div>
              <div className="bg-white bg-opacity-15 backdrop-blur-lg p-4 rounded-xl mb-4 flex justify-between items-center">
                <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1))}
                  className="bg-white bg-opacity-30 px-4 py-2 rounded-lg font-bold">‚Üê</button>
                <span className="font-bold">{currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</span>
                <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1))}
                  className="bg-white bg-opacity-30 px-4 py-2 rounded-lg font-bold">‚Üí</button>
              </div>
              <div className="grid grid-cols-7 gap-2">
                {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map(d => (
                  <div key={d} className="text-center font-bold text-sm">{d}</div>
                ))}
                {(() => {
                  const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
                  const lastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
                  const days = [];
                  for (let i = 0; i < firstDay.getDay(); i++) {
                    days.push(<div key={`empty-${i}`} />);
                  }
                  for (let d = 1; d <= lastDay.getDate(); d++) {
                    const dateStr = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), d).toISOString().split('T')[0];
                    const log = logs.find(l => l.date.split('T')[0] === dateStr);
                    days.push(
                      <div key={d}
                        className={`aspect-square bg-white bg-opacity-15 rounded-lg flex flex-col items-center justify-center text-sm ${log ? 'bg-opacity-30 border-2 border-white' : ''}`}>
                        <div>{d}</div>
                        {log && <div className="text-xl">{log.mood || 'üí™'}</div>}
                      </div>
                    );
                  }
                  return days;
                })()}
              </div>
            </div>
          )}
          {activeTab === 'pr' && (
            <div className="space-y-4">
              <div className="bg-white bg-opacity-15 backdrop-blur-lg p-4 rounded-xl">
                <h3 className="text-lg font-bold mb-3 uppercase">üö¥ Spin Records</h3>
                <div className="space-y-2">
                  <div className="bg-black bg-opacity-20 p-3 rounded-lg">Highest Avg Watt: {prs.spinMaxWatt || '--'}W</div>
                  <div className="bg-black bg-opacity-20 p-3 rounded-lg">Longest Distance: {prs.spinMaxDistance || '--'}km</div>
                  <div className="bg-black bg-opacity-20 p-3 rounded-lg">Highest TSS: {prs.spinMaxTSS || '--'}</div>
                </div>
              </div>
              <div className="bg-white bg-opacity-15 backdrop-blur-lg p-4 rounded-xl">
                <h3 className="text-lg font-bold mb-3 uppercase">üèãÔ∏è Bodybump Records</h3>
                <div className="bg-black bg-opacity-20 p-3 rounded-lg">Most Tracks: {prs.bbMaxTracks || '--'}</div>
              </div>
              <div className="bg-white bg-opacity-15 backdrop-blur-lg p-4 rounded-xl">
                <h3 className="text-lg font-bold mb-3 uppercase">üß± Brick Records</h3>
                <div className="space-y-2">
                  <div className="bg-black bg-opacity-20 p-3 rounded-lg">Most Activities: {prs.brickMaxActivities || '--'}</div>
                  <div className="bg-black bg-opacity-20 p-3 rounded-lg">Longest Time: {prs.brickMaxTime || '--'} min</div>
                </div>
              </div>
              <div className="bg-white bg-opacity-15 backdrop-blur-lg p-4 rounded-xl">
                <h3 className="text-lg font-bold mb-3 uppercase">üî• General</h3>
                <div className="bg-black bg-opacity-20 p-3 rounded-lg">Streak: {prs.streak || '--'} days</div>
              </div>
            </div>
          )}
          {activeTab === 'chat' && (
            <div className="flex flex-col h-full">
              <div className="bg-white bg-opacity-15 backdrop-blur-lg p-4 rounded-xl mb-4">
                <label className="block font-bold text-sm mb-2 uppercase">OpenAI API Key</label>
                <input type="password" value={apiKey}
                  onChange={async (e) => {
                    setApiKey(e.target.value);
                    await window.storage.set('coach_girlie_api_key', e.target.value);
                  }}
                  placeholder="sk-..." className="w-full p-2 rounded-lg bg-white text-gray-900" />
              </div>
              <div className="flex-1 space-y-3 overflow-y-auto mb-4">
                {chatMessages.map((msg, idx) => (
                  <div key={idx}
                    className={`p-3 rounded-xl ${msg.role === 'user' ? 'bg-white bg-opacity-25 ml-8' : 'bg-gradient-to-r from-pink-500 to-purple-600 mr-8'}`}>
                    <div className="font-bold text-xs mb-1">{msg.role === 'user' ? 'YOU' : 'COACH GIRLIE'}</div>
                    <div>{msg.content}</div>
                  </div>
                ))}
              </div>
              <div className="flex gap-2">
                <input type="text" value={chatInput} onChange={(e) => setChatInput(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && sendChatMessage()}
                  placeholder="Ask Coach Girlie..." className="flex-1 p-3 rounded-lg bg-white text-gray-900" />
                <button onClick={sendChatMessage}
                  className="bg-gradient-to-r from-pink-500 to-purple-600 px-6 py-3 rounded-lg font-bold">
                  SEND
                </button>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
